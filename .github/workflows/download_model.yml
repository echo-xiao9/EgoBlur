name: Model Download Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  download-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download EgoBlur Gen2 models
        env:
          FACE_MODEL_URL: "https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An8ONis8Gp-rzgPM06SVUcz6MjMEQPau6sgr25xJrEvmEfvr_YRW0UWHKSlOtV3z0fj98V2uqqnPbnLrU0SARtcph53QmA-x3nrdYxFl-OcYe0nOc7Y0BQx4SS7tKF3zXjcPXKiQS8WEl8k7Ag.zip/ego_blur_face_gen2.zip?_nc_gid=Bnqzzs-Hw3TUw2xPOdS8vg&_nc_oc=AdnCyC1Ksl12pYZexXmg6i7tazF6p49YZh_QBOQT91JZlQp3Q7qRMMkiP6oNXcM3EDQ&sdl=1&ccb=10-5&oh=00_AfnfEq9kXuGF18-fZNfXkovu_VgiAioxjmyAMU5fLVFrNg&oe=69586C58&_nc_sid=5cb19f"
          LP_MODEL_URL: "https://scontent-sea5-1.xx.fbcdn.net/m1/v/t6/An9xrh1Lyyk5EuJPXmDPC2AZQzZp3fLxlw9twrwWc9iNl8PfgzOMs0NehwSRTJN4tZ5iwPh1voT8JFpDeWCzGZnSSsXMaIzNPNjF70lWWMKHiFgOsE-ZT8aP9oTHTXGraEWc5_e3BMssDxgS.zip/ego_blur_lp_gen2.zip?_nc_gid=-efrwVRzJldEhB_POMBZtg&_nc_oc=Adn55ZpzPXSfvFpmDnVLv2yXzVw0O_8xrc82gzPBSQAjpMjyF3t2U6_cur-059H47j4&sdl=1&ccb=10-5&oh=00_AfnH9BBrj206CxDWlxtTDz3NVt3lOD56VSOMttr-qzGktw&oe=6959230A&_nc_sid=5cb19f"
        run: |
          set -euxo pipefail
          MODELS_DIR="${PWD}/.ci_gen2_models"
          rm -rf "${MODELS_DIR}"
          mkdir -p "${MODELS_DIR}"
          wget -O "${MODELS_DIR}/ego_blur_face_gen2.zip" ${FACE_MODEL_URL}
          wget -O "${MODELS_DIR}/ego_blur_lp_gen2.zip" ${LP_MODEL_URL}
          unzip -o "${MODELS_DIR}/ego_blur_face_gen2.zip" -d "${MODELS_DIR}"
          unzip -o "${MODELS_DIR}/ego_blur_lp_gen2.zip" -d "${MODELS_DIR}"
          FACE_MODEL_PATH="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_face_gen2*.jit' -print -quit || true)"
          LP_MODEL_PATH="$(find "${MODELS_DIR}" -maxdepth 2 -name 'ego_blur_lp_gen2*.jit' -print -quit || true)"
          if [ -z "${FACE_MODEL_PATH}" ]; then
            echo "::error::Unable to locate ego_blur_face_gen2 model after extraction"
            exit 1
          fi
          if [ -z "${LP_MODEL_PATH}" ]; then
            echo "::error::Unable to locate ego_blur_lp_gen2 model after extraction"
            exit 1
          fi
          echo "FACE_MODEL_PATH=${FACE_MODEL_PATH}"
          echo "LP_MODEL_PATH=${LP_MODEL_PATH}"

