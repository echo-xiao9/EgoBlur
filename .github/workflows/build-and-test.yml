name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  TORCH_VERSION: "2.9.1"
  TORCHVISION_VERSION: "0.24.1"
  CUDA_VERSION: "13.0"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

jobs:
  linux:
    name: Linux (${{ matrix.distro.name }} / py${{ matrix.python-version }})
    runs-on: ubuntu-22.04
    container:
      image: ${{ matrix.distro.image }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        distro:
          - name: ubuntu-20.04
            image: ubuntu:20.04
            package_manager: apt
          - name: ubuntu-22.04
            image: ubuntu:22.04
            package_manager: apt
          - name: ubuntu-24.04
            image: ubuntu:24.04
            package_manager: apt
          - name: fedora-43
            image: fedora:43
            package_manager: dnf
    env:
      PYTORCH_INDEX_URL: https://download.pytorch.org/whl/cu130
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          if [ "${{ matrix.distro.package_manager }}" = "apt" ]; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              git curl ca-certificates build-essential ffmpeg libsm6 libxext6 xz-utils \
              bzip2 libbz2-dev
            rm -rf /var/lib/apt/lists/*
          else
            dnf install -y \
              git curl ca-certificates gcc gcc-c++ make ffmpeg mesa-libGL libSM libXext xz \
              bzip2 bzip2-libs
          fi

      - name: Install Python ${{ matrix.python-version }}
        run: |
          PY_VER="${{ matrix.python-version }}"
          if [ "${{ matrix.distro.package_manager }}" = "apt" ]; then
            export DEBIAN_FRONTEND=noninteractive
            export TZ=Etc/UTC
            apt-get update
            apt-get install -y tzdata
            ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime
            dpkg-reconfigure -f noninteractive tzdata
            apt-get install -y software-properties-common python3-pip
            add-apt-repository universe -y
            add-apt-repository ppa:deadsnakes/ppa -y
            apt-get update
            apt-get upgrade -y
            apt-get install -y \
              "python${PY_VER}" \
              "python${PY_VER}-venv" || echo "python${PY_VER}-venv not available, will fall back to virtualenv"
            if apt-cache show "python${PY_VER}-distutils" >/dev/null 2>&1; then
              apt-get install -y "python${PY_VER}-distutils"
            fi
          else
            dnf install -y \
              "python${PY_VER}" \
              "python${PY_VER}-devel"
          fi

      - name: Create virtual environment
        run: |
          PY_BIN="python${{ matrix.python-version }}"
          if ! $PY_BIN -m venv .venv; then
            echo "Falling back to virtualenv for ${PY_BIN}"
            python3 -m pip install --upgrade pip
            python3 -m pip install --upgrade virtualenv
            python3 -m virtualenv -p $PY_BIN .venv
          fi
          . .venv/bin/activate
          python -m pip install --upgrade pip

      - name: Install EgoBlur from source
        env:
          PIP_EXTRA_INDEX_URL: ${{ env.PYTORCH_INDEX_URL }}
        run: |
          . .venv/bin/activate
          pip install --no-cache-dir .

      - name: Smoke test CLI entry points
        run: |
          . .venv/bin/activate
          egoblur-gen2 -h
          egoblur-gen1 -h

  macos:
    name: macOS (${{ matrix.runner }} / py${{ matrix.python-version }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: ["macos-13", "macos-14"]
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          brew update
          brew install ffmpeg

      - name: Create virtual environment
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip

      - name: Install EgoBlur from source
        run: |
          . .venv/bin/activate
          pip install --no-cache-dir .

      - name: Smoke test CLI entry points
        run: |
          . .venv/bin/activate
          egoblur-gen2 -h
          egoblur-gen1 -h

